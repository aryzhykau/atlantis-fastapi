# Работа с инвойсами

## Общее описание
Инвойсы в системе Atlantis представляют собой требования к оплате услуг. Они автоматически погашаются при наличии достаточного баланса у клиента.

## Жизненный цикл инвойса

### Создание
- Инициируется админом или тренером
- Требует указания клиента и суммы
- Обязательно наличие описания
- Обязательно указать сущность к которой привязан инвойс и которая должна быть оплачена
- Автоматическая проверка возможности создания

### Автоматическое погашение
- Проверка баланса клиента
- Мгновенное погашение при достаточном балансе
- Списание средств с баланса
- Обновление статуса инвойса

### Отмена погашения
- Происходит автоматически только при отмене платежа
- Система берет все оплаченные инвойсы в порядке от нового к старому
- Последовательно отменяет оплату, пока не израсходует сумму отменяемого платежа
- Если сумма платежа меньше стоимости инвойса, инвойс отменяется целиком
- Статус отмененных инвойсов возвращается в "Неоплачен"

## Статусы инвойса

### Неоплачен
- Ожидает оплаты
- Может быть погашен при наличии средств на балансе
- Участвует в автоматическом погашении при пополнении баланса
- Может быть отменен администратором с указанием причины

### Оплачен
- Успешно погашен
- Средства списаны с баланса
- Может вернуться в статус "Неоплачен" при отмене платежа
- Сохраняет историю операций оплаты/отмены

### Отменен
- Инвойс исключен из процесса оплаты
- Обязательно указание причины отмены
- Доступно только администраторам
- Сохраняется в истории для аудита
- Нельзя вернуть в другие статусы

## Правила и ограничения

### Создание инвойсов
- Происходит автоматически при следующих событиях:
  * Добавление абонемента студенту
  * Отметка о посещении тренировки
  * Отметка о пропуске тренировки
- Система автоматически заполняет все необходимые данные
- После создания сразу проверяется возможность автоматического погашения

### Погашение
- Автоматическое при наличии средств
- Проверка достаточности баланса
- Атомарность операции

### Отмена
- Только админами
- Проверка возможности отмены
- Возврат средств при необходимости

## Технические аспекты
- Интеграция с системой баланса
- Автоматические уведомления
- Сохранение истории операций
- Транзакционность при изменениях 