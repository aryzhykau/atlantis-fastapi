# Автоматические финансовые процессы

## Триггеры создания инвойсов

### 1. Добавление абонемента
```mermaid
graph TD
    A[Добавление абонемента] --> B[Автоматическое создание инвойса]
    B --> C{Есть баланс?}
    C -->|Да| D[Автоматическое погашение]
    C -->|Нет| E[Инвойс остается неоплаченным]
```

#### Процесс
1. Тренер/админ добавляет абонемент студенту
2. Система автоматически создает инвойс
3. Проверяется баланс клиента
4. При достаточном балансе - автоматическое погашение
5. При недостаточном балансе - инвойс остается неоплаченным

### 2. Отметка о посещении/пропуске тренировки
```mermaid
graph TD
    A[Отметка о тренировке] --> B[Создание инвойса]
    B --> C{Тип отметки}
    C -->|Присутствовал| D[Стандартный инвойс]
    C -->|Отсутствовал| E[Инвойс за пропуск]
    D --> F{Проверка баланса}
    E --> F
    F -->|Достаточно| G[Автопогашение]
    F -->|Недостаточно| H[Ожидание оплаты]
```

#### Процесс
1. Тренер отмечает присутствие/отсутствие
2. Система создает инвойс независимо от типа отметки
3. Проверяется баланс клиента
4. При достаточном балансе - автоматическое погашение
5. При недостаточном балансе - инвойс остается неоплаченным

## Процесс погашения инвойсов

### Автоматическое погашение при пополнении баланса
```mermaid
graph TD
    A[Регистрация платежа] --> B[Пополнение баланса]
    B --> C[Получение списка неоплаченных инвойсов]
    C --> D[Сортировка по дате создания]
    D --> E{Есть неоплаченные инвойсы?}
    E -->|Да| F{Достаточно баланса?}
    F -->|Да| G[Погашение старейшего инвойса]
    G --> E
    F -->|Нет| H[Завершение процесса]
    E -->|Нет| H
```

#### Процесс
1. Регистрация платежа
2. Мгновенное пополнение баланса клиента
3. Получение списка всех неоплаченных инвойсов клиента
4. Сортировка инвойсов по дате создания (от старых к новым)
5. Последовательное погашение инвойсов пока:
   - Есть неоплаченные инвойсы
   - Достаточно средств на балансе

## Процесс отмены платежей

### Общий принцип отмены
- При обнаружении ошибки в платеже необходимо его полностью отменить
- После отмены вносится новый корректный платеж
- Частичная отмена платежа не допускается

### Алгоритм отмены платежа
```mermaid
graph TD
    A[Инициация отмены платежа] --> B[Получение суммы платежа]
    B --> C[Получение баланса клиента]
    C --> D{Баланс >= Сумма платежа?}
    D -->|Да| E[Уменьшение баланса]
    D -->|Нет| F[Обнуление баланса]
    F --> G[Получение оплаченных инвойсов]
    G --> H[Сортировка от новых к старым]
    H --> I{Осталась сумма для покрытия?}
    I -->|Да| J{Сумма >= стоимости инвойса?}
    J -->|Да| K[Отмена оплаты инвойса]
    K --> L[Уменьшение остатка суммы]
    L --> I
    J -->|Нет| M[Отмена оплаты инвойса]
    M --> N[Зачисление разницы в баланс]
    I -->|Нет| O[Завершение процесса]
    E --> O
```

#### Процесс отмены
1. Администратор инициирует отмену платежа
2. Система получает сумму отменяемого платежа и баланс клиента
3. Сравнивается баланс с суммой платежа:
   - Если баланс >= сумма платежа: просто уменьшаем баланс и завершаем процесс
   - Если баланс < сумма платежа: зануляем баланс и продолжаем процесс
4. Формируется список оплаченных инвойсов в обратном порядке (от новых к старым)
5. Для каждого инвойса:
   - Если остаточная сумма >= стоимость инвойса:
     * Отменяется оплата инвойса
     * Остаточная сумма уменьшается на стоимость инвойса
   - Если остаточная сумма < стоимость инвойса:
     * Отменяется оплата инвойса
     * Разница зачисляется в баланс клиента
     * Процесс завершается

### Пример процесса отмены с достаточным балансом
```
Исходные данные:
- Платеж на 5000р
- Текущий баланс клиента: 7000р

Процесс отмены:
1. Проверка баланса: 7000р >= 5000р
2. Уменьшение баланса на 5000р
3. Новый баланс: 2000р
4. Оплаченные инвойсы не затрагиваются
```

### Пример процесса отмены с недостаточным балансом
```
Исходные данные:
- Платеж на 5000р
- Текущий баланс клиента: 2000р
- Оплаченные инвойсы (от новых к старым):
  * Инвойс 1: 2000р
  * Инвойс 2: 2000р
  * Инвойс 3: 500р

Процесс отмены:
1. Проверка баланса: 2000р < 5000р
2. Обнуление баланса
3. Остаточная сумма: 3000р (5000р - 2000р)
4. Отмена Инвойса 1 (2000р)
   Остаточная сумма: 1000р
5. Отмена Инвойса 2 (2000р)
   Поскольку остаточная сумма (1000р) < стоимость инвойса (2000р):
   - Инвойс полностью отменяется
   - Разница (1000р) зачисляется в баланс
6. Новый баланс: 1000р
```

### Правила и ограничения отмены

#### Права доступа
- Отмена платежей доступна только администраторам
- Система протоколирует все действия по отмене
- Требуется указание причины отмены

#### Ограничения процесса
- Нельзя отменить часть платежа
- Если баланс достаточный, инвойсы не затрагиваются
- При недостаточном балансе отмена идет от новых инвойсов к старым
- При невозможности отменить инвойс целиком, остаток идет в баланс

#### Технические аспекты
- Процесс отмены выполняется в одной транзакции
- Все этапы отмены логируются
- Система создает уведомления о каждом этапе
- История операций сохраняется для аудита

### Последствия отмены

#### Для инвойсов
- Инвойсы возвращаются в статус "Неоплачен"
- Сохраняется история оплаты и отмены
- Инвойсы могут быть оплачены повторно

#### Для баланса
- При достаточном балансе - просто уменьшение
- При недостаточном балансе - обнуление и возможное пополнение остатка
- Система пересчитывает доступные средства

#### Для отчетности
- Отмененные операции помечаются в отчетах
- Создаются корректировочные документы
- Обновляется финансовая статистика

## Правила и ограничения

### Создание инвойсов
- Инвойсы создаются автоматически системой
- Каждый инвойс привязан к конкретному событию (абонемент/тренировка)
- Система всегда пытается погасить инвойс сразу после создания

### Погашение инвойсов
- Строгий порядок погашения: от старых к новым
- Частичное погашение инвойсов не допускается
- Погашение происходит автоматически при достаточном балансе

### Платежи
- Моментальное пополнение баланса
- Автоматический запуск процесса погашения инвойсов
- Сохранение истории операций

## Технические требования

### Атомарность операций
- Создание инвойса и проверка баланса - одна транзакция
- Погашение инвойса и списание средств - одна транзакция
- Пополнение баланса и погашение инвойсов - одна транзакция

### Очередность операций
- Строгая последовательность обработки платежей
- Гарантированная очередность погашения инвойсов
- Логирование всех этапов процесса

### Обработка ошибок
- Откат транзакций при ошибках
- Сохранение состояния до и после операций
- Уведомление администраторов о проблемах 