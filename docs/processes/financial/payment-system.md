# Платежная система

## Общее описание
Платежная система Atlantis обеспечивает регистрацию и учет наличных платежей клиентов. Она тесно интегрирована с системой баланса и инвойсов.

## Создание платежей

### Автоматическое создание
- Возможно при отметке тренером о присутствии/отсутствии клиента
- Тренер должен указать сумму платежа
- Если сумма не указана, платеж не создается
- При создании платежа:
  * Мгновенное пополнение баланса клиента
  * Автоматический запуск процесса погашения неоплаченных инвойсов

### Ручное создание (только админ)
1. Выбор клиента
2. Указание суммы платежа
3. Подтверждение получения наличных
4. Мгновенное пополнение баланса
5. Автоматический запуск процесса погашения неоплаченных инвойсов

## Обработка платежа
- Проверка корректности данных
- Мгновенное пополнение баланса клиента
- Создание записи в истории платежей
- Автоматическое погашение неоплаченных инвойсов от старых к новым
- Сохранение остатка на балансе клиента

## Отмена платежей

### Процесс отмены
1. Проверка возможности отмены (только админы)
2. Получение суммы отменяемого платежа и текущего баланса клиента
3. Проверка достаточности баланса для отмены:
   * Если баланс >= сумма платежа: уменьшение баланса на сумму платежа
   * Если баланс < сумма платежа:
     - Обнуление баланса клиента
     - Отмена оплаты инвойсов от новых к старым
     - Если остаточная сумма < стоимость инвойса, остаток идет в баланс
4. Создание записей в истории для каждого этапа отмены
5. Сохранение причины отмены

### Ограничения отмены
- Доступно только администраторам
- Требуется указание причины отмены
- Отмена происходит разными способами в зависимости от текущего баланса
- При достаточном балансе инвойсы не затрагиваются
- При недостаточном балансе отменяются инвойсы от новых к старым
- Сохранение подробной истории операции

## Права доступа

### Админы
- Ручное создание платежей
- Отмена платежей
- Просмотр всей истории платежей
- Доступ к отчетам и статистике

### Тренеры
- Автоматическое создание платежей через отметку присутствия/отсутствия

## Технические аспекты
- Сохранение истории всех операций
- Логирование действий пользователей
- Формирование фискальных документов
- Резервное копирование данных
- Аудит операций 