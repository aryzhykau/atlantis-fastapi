# Управление расписанием

## Общее описание
Система управления расписанием Atlantis позволяет создавать и управлять шаблонами регулярных тренировок. Расписание является основой для автоматического создания реальных тренировок и управления записями студентов.

## Типы расписаний

### По периодичности
- Еженедельные тренировки
- Разовые тренировки
- Временные замены

### Параметры расписания
- Время проведения (фиксированная длительность - 1 час)
- Тренер
- Тип тренировки
- Список студентов с датами начала посещения
- Максимальное количество участников

## Создание расписания

### Механизм создания
- Создание шаблона расписания администратором.
- Привязка студентов к шаблону с указанием даты начала посещений.
- Автоматическое создание реальных тренировок на неделю вперед на основе шаблонов.

### Процесс добавления студента в шаблон
При добавлении студента в существующий шаблон (`TrainingStudentTemplate`) система выполняет следующую проверку, чтобы не допустить переполнения групп.

1.  **Инициация**: Администратор добавляет студента в шаблон тренировки.
2.  **Получение данных**: Система извлекает данные шаблона, включая связанный с ним тип тренировки (`TrainingType`).
3.  **Проверка лимита**: Система сравнивает текущее количество студентов, уже привязанных к этому шаблону, с полем `max_participants` из типа тренировки.
4.  **Принятие решения**:
    - **Если лимит не достигнут**: Студент успешно добавляется в шаблон.
    - **Если лимит достигнут**: Система возвращает ошибку, и администратор получает уведомление, что добавить студента нельзя, так как группа заполнена.

Эта проверка гарантирует, что на этапе планирования расписания учитываются ограничения по вместимости, что предотвращает создание реальных тренировок с превышением лимита участников.

```mermaid
graph TD
    A[Администратор добавляет<br>студента в шаблон] --> B{Получить шаблон и<br>связанный TrainingType};
    B --> C{Сравнить кол-во студентов<br>в шаблоне с max_participants};
    C -->|Лимит не достигнут| D[Добавить студента в<br>TrainingStudentTemplate];
    C -->|Лимит достигнут| E[Вернуть ошибку<br> "Группа заполнена"];
    D --> F[✓ Студент успешно<br>добавлен в расписание];
    E --> G[✗ Студент не добавлен];
```

### Правила создания
- Обязательное указание тренера
- Проверка доступности тренера (запрет пересечений тренировок для одного тренера)
- Возможность параллельных тренировок с разными тренерами

## Редактирование расписания

### Изменение параметров (только администраторами)
- Время проведения
- Тренер
- Тип тренировки
- Список студентов и их даты начала

### Правила редактирования
- Изменения применяются только к будущим тренировкам
- При изменении времени проверяются конфликты с другими тренировками тренера
- Уведомление записанных участников при изменениях
- История изменений сохраняется
- Доступ только для администраторов

## Отмена и замена

### Отмена тренировок
1. Отмена конкретной тренировки
2. При отмене запускаются связанные финансовые процессы

### Замена тренера
- Временная замена на конкретную дату
- Постоянная замена в расписании
- Проверка отсутствия конфликтов у нового тренера

## Технические аспекты

### Создание тренировок
- Автоматическое создание на неделю вперед
- Автоматическое добавление студентов из шаблона по датам начала

### Контроль конфликтов
- Проверка занятости тренера (запрет пересечений)
- Разрешение параллельных тренировок для разных тренеров

### Уведомления
- Оповещение тренеров о расписании
- Уведомление студентов об изменениях
- Информирование о заменах и отменах

## Правила и ограничения

### Основные правила
- Фиксированная длительность тренировки - 1 час
- Запрет пересечения тренировок одного тренера
- Разрешение параллельных тренировок с разными тренерами
- Максимальное количество участников зависит от типа тренировки

### Изменение расписания
- Только администратор может менять расписание
- Изменения фиксируются в истории
- Автоматическое уведомление всех затронутых участников

### Отмена тренировок
- Возможность отмены только будущих тренировок
- Автоматическое уведомление участников
- Запуск связанных финансовых процессов при отмене

## Технические требования

### Атомарность операций
- Создание/изменение расписания - одна транзакция
- Отмена тренировок и уведомления - одна транзакция
- Замена тренера и проверки - одна транзакция

### Очередность операций
- Проверка конфликтов перед созданием
- Уведомления после подтверждения изменений
- Логирование всех действий

### Обработка ошибок
- Откат изменений при ошибках
- Сохранение состояния до и после изменений
- Уведомление администраторов о проблемах

### Правила отмены участия
- Отмена участия за 12 и более часов до начала:
  - Полное удаление из тренировки
  - Возврат тренировки в абонемент
  - Без штрафных санкций
- Отмена участия менее чем за 12 часов:
  - Автоматическая установка статуса "отсутствовал"
  - Тренировка считается использованной
  - Без возможности возврата в абонемент
- Только администраторы могут отменять участие студентов
- Все отмены фиксируются в истории изменений 